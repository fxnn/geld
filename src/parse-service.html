<link rel="import" href="../bower_components/polymer/polymer.html">

<script>var module = {};</script>
<script src="../bower_components/parser-generator/parser-generator.js"></script>
<script>var Parser = module.exports;</script>

<script src="parse-grammar.js"></script>

<dom-module id="parse-service">

    <script>
        Polymer({
            is: 'parse-service',

            // flatten(a) flattens an array a of arrays
            // http://stackoverflow.com/a/16953805
            _flatten: function(a, r){
                if(!r){ r = []}
                for(var i=0; i<a.length; i++){
                    if(a[i].constructor == Array){
                        flattenArrayOfArrays(a[i], r);
                    }else{
                        r.push(a[i]);
                    }
                }
                return r;
            },

            _tokens: function(o) {
                var o = Parser.Operators;
                var g = new Grammar(o);

                // basic tokens
                g.$token("lbrace", "{");
                g.$token("rbrace", "}");
                g.$token("colon", ":");
                g.$token("dash", "-");
                g.$token("number", /[0-9]+/);
                g.$token("alpha", /[A-Z]+/);
                g.$token("alphanum", /[A-Z0-9]+/);
                g.$token("anychar", /[a-zA-Z0-9/?:().,'+\r\n -]+/);
                g.$token("float", /[0-9]+,[0-9]+/);
                g.$token("newline", "\r\n");

                // basic rules
                g.$rule("tag", o.each(g.number, g.colon));
                g.$rule("fieldname", o.each(g.newline, g.colon, g.tag));
                g.$rule("end", o.each(g.newline, g.dash));

                return g;
            },

            _grammar: function(o) {
                var g = this._tokens(o);

                g.$rule("headerblock", o.between(g.lbrace, o.each(g.tag, g.aplhanum), g.rbrace));
                // NOTE, that a header might be empty
                g.$rule("header", o.many(g.headerblock));

                g.$rule("field", o.each(g.fieldname, o.until(o.any(g.fieldname, g.end))));
                g.$rule("fields", o.many(g.field));
                g.$rule("fieldsInBraces", o.between(g.lbrace, o.each(g.tag, g.fields), g.rbrace));
                // NOTE, that I found examples with and without braces
                g.$rule("body", o.any(g.fields, g.fieldsInBraces));

                g.$rule("file", o.each(g.header, g.body));

                return g;
            },

            parseTransactions: function(data) {
                console.log("Parsing " + data.length + " bytes ...");

                var parse = this._grammar(Parser.Operators);
                return parse.file(data);
            }
        });
    </script>

</dom-module>