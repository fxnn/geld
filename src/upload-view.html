<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="mt940-parser-service.html">

<dom-module id="upload-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      .icon-header {
        --iron-icon-width: 2em;
        --iron-icon-height: 2em;
        --iron-icon-fill-color: var(--app-secondary-color);
      }
    </style>

    <mt940-parser-service id="mt940ParserService"></mt940-parser-service>

    <div class="card">
      <h1>
        <iron-icon icon="icons:file-upload" class="icon-header"></iron-icon>
        Upload transactions
      </h1>
      <p>Please download your transactions from your bank and upload them here.</p>
    </div>

    <div class="card">
      <vaadin-upload on-upload-before="handleUploadStarting"></vaadin-upload>
      <!-- on-upload-abort, on-upload-error, on-upload-retry -->
    </div>
  </template>

  <script>
    Polymer({
      is: 'upload-view',

      _read: function(uploadComponent, file) {
        console.log("Upload starting: " + file.name);

        file.set = function(property, value) {
          // HINT: the array models a path, cf. https://www.polymer-project.org/1.0/docs/devguide/model-data#set-path
          uploadComponent.set(['files', uploadComponent.files.indexOf(this), property], value);
        }

        // cf. https://developer.mozilla.org/de/docs/Web/API/FileReader
        var reader = new FileReader();
        reader.file = file;
        reader.onload = this._handleReaderSuccess.bind(this);
        //reader.onerror, reader.onabort, reader.onloadstart, reader.onprogress
        reader.readAsText(file);
      },

      _handleReaderSuccess: function(e) {
        var reader = e.target;
        var file = reader.file;

        file.set('progress', 100);
        file.set('complete', true);

        this.$.mt940ParserService.parseTransactions(reader.result);
      },

      handleUploadStarting: function(event) {
        event.preventDefault();
        this._read(event.target, event.detail.file);
      }
    });
  </script>
</dom-module>
