<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>parse-service</title>

    <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>

    <!-- Import the element to test -->
    <link rel="import" href="../src/mt940-parser-service.html">
  </head>
  <body>
    <test-fixture id="mt940-parser-service-fixture">
      <template>
        <mt940-parser-service id="sut"></mt940-parser-service>

        <h1>Example data</h1>

        <h2>SWIFT MT940 domestic 1</h2>
        <p>From <a href="http://martin.hinner.info/bankconvert/swift_mt940_942.pdf">martin.hinner.info</a>.</p>
        <pre id="example-swift-mt940-domestic-1">{1:F01BPHKPLPKXXX0000000000}{2:I940BOFAUS6BXBAMN}{4:
:20:TELEWIZORY S.A.
:25:BPHKPLPK/320000546101
:28C:00084/001
:60F:C031002PLN40000,00
:61:0310201020C20000,00FMSCNONREF//8327000090031789
Card transaction
:86: 020?00Wyplata-(dysp/przel)?2008106000760000777777777777?2115617?
22INFO INFO INFO INFO INFO INFO 1 END?23INFO INFO INFO INFO INFO
INFO 2 END?24ZAPLATA ZA FABRYKATY DO TUB?25 - 200 S ZTUK, TRANZY
STORY-?26300 SZT GR544 I OPORNIKI-5?2700 SZT GTX847 FAKTURA 333/
2?28003.?3010600076?310000777777777777?32HUTA SZKLA TOPIC UL
PRZEMY?33SLOWA 67 32-669 WROCLAW?38PL081060007600007777777
77777
:61:0310201020D10000,00FTRFREF 25611247//8327000090031790
Transfer
:86: 020?00Wyplata-(dysp/przel)?2008106000760000777777777777?2115617?
22INFO INFO INFO INFO INFO INFO 1 END?23INFO INFO INFO INFO INFO
INFO 2 END?24ZAPLATA ZA FABRYKATY DO TUB?25 - 200 S ZTUK, TRANZY
STORY-?26300 SZT GR544 I OPORNIKI-5?2700 SZT GTX847 FAKTURA 333/
2?28003.?3010600076?310000777777777777?38PL081060007600007777777
77777
:61:0310201020C40,00FTRFNONREF//8327000090031791
Interest credit 
:86: 844?00Uznanie kwotÄ… odsetek?20Odsetki od lokaty nr 101000?21022086
:62F:C020325PLN50040,00
-}</pre>

        <h2>SWIFT MT940 domestic 2</h2>
        <p>From <a href="http://martin.hinner.info/bankconvert/swift_mt940_942.pdf">martin.hinner.info</a>.</p>
        <pre id="example-swift-mt940-domestic-2">{1:F01BPHKPLPKXXXX0312092220}{2:I940AABSDE31XXXXN}{4:
:20: NETMEXID
:25:BPHKPLPK/666666666666
:28C:00035/001
:60F:C031209PLN95,03
:61:0312091209C20000,FBARNONREF//1010001272972001
Payment of funds to own account
:86:082?00Wplata wlasna?2115616?24Rach.wplacajac. 101000
:61:0312091209D4000,FTRFREF:BPHPBK/081203/0001//59512092914002
Transfer of funds
:86: 020?00Wyplata-(dysp/przel)?2008106000760000777777777777?2115617?
22INFO INFO INFO INFO INFO INFO 1 END?23INFO INFO INFO INFO INFO
INFO 2 END?24ZAPLATA ZA FABRYKATY DO TUB?25 - 200 S ZTUK, TRANZY
STORY-?26300 SZT GR544 I OPORNIKI-5?2700 SZT GTX847 FAKTURA 333/
2?28003.?3010600076?310000777777777777?32HUTA SZKLA TOPIC UL
PRZEMY?33SLOWA 67 32-669 WROCLAW?38PL081060007600007777777
77777
:61:0312091209D880,FTRFREF:BPHPBK/081203/0003//59512092915002
ZUS-social security payment :86:030?00Wyplata-(dysp/przel)?2010101023-26-139-51?2115618?24Deklar
acja:200309?25Numer deklaracji:09?26Typ wplaty:S?27NIP Platnika:
6792496639?28Typ id uzup.:1?26Id uzup.:DD8012790?3010101023?3126
-139-51?32ZAKLAD UBEZPIECZEN SPOLECZN?33YCH
:61:0312091209D600,FTRFREF:BPHPBK/081203/0002//59512092916002
Internal Revenue Service payment
:86:031?00Wyplata-(dysp/przel)?2069101012700004592221000000?2115619?
24Wplata na organ podatkowy?25Typ identyfikatora:N?26Zawartosc I
D:6792496639?27Okres:03M09?27Symbol formularza:PIT4?28Opis:ZAPL.
POD. DAFIK?3010101270?310004592221000000?32Urzad Skarbowy Krakow
tar?33e Miasto Krakow?38PL69101012700004592221000000
:62F:C031209PLN14615,03
-}</pre>

        <h2>SWIFT MT940 international</h2>
        <p>From <a href="http://martin.hinner.info/bankconvert/swift_mt940_942.pdf">martin.hinner.info</a>.</p>
        <pre id="example-swift-mt940-international-1">{1:F01BPHKPLPKXXX0000000000}{2:I940BOFAUS6BXBAMN}{4:
:20:TELEWIZORY S.A.
:25:BPHKPLPK/320000546101
:28C:00084/001
:60F:C031002EUR5000,00
:61:0310201020D1088,41FTRFREF 12345678/2003//8327000090031790
Transfer
:86:020?00Wyplata/przelew?20DEUTSCHE ELEKTROAPPARATUR?21OBENSTRAS
SE 4 MUNCHEN?22OCMT/EUR1088,41?23CHGS/SHA/EUR20,00?24FAKTURA 333
/2003 ZAPLATA ZA?25FABRYKATY DO TUB 200 SZTUK?26GZX 76 I 300 SZT
UK GZY 77 T?27RANZYSTORY 300 SZTUK BT34SX?28OPORNIKI 500 SZTUK W 
Q2?29232FX?30HYVEDEMM700?31701890012872?38DE09700202701890012872
:62F:C031020EUR3891,59
-}</pre>

      <h2>Sparkasse MT940 export</h2>
      <pre id="example-sparkasse-mt940-1">
:20:STARTUMSE
:25:83050000/0123456789
:28C:00000/001
:60F:C161122EUR227,77
:61:1611231123DR106,75N010NONREF
:86:006?00EIGENE KREDITKARTENABRECHN.?101234?20KREDITKARTEN-ABR. 
VOM 18.11?21447595XXXXXX7209     106,75?3083050000?310123456789?3
2SPARKASSE GERA-GREIZ?34123
:62F:C161123EUR121,02
-
:20:STARTUMSE
:25:83050000/0123456789
:28C:00000/001
:60F:C161123EUR121,02
:61:1611251125DR5,15N011NONREF
:86:107?00SEPA-ELV-LASTSCHRIFT?101234?20EREF+12345678901234567890
12?2112345?22MREF+0123456789012345678890?23CRED+01234567890123456
7?24SVWZ+0123456789012345678901?2512345 REWE SAGT DANKE. 6789?260
123?30ABCDEFGH?310123456789012345678901?32REWE Berlin/Friede?3401
2
:61:1611251125DR60,00N032NONREF
:86:106?00AUSZAHLUNG?109123?20SVWZ+2016-11-25T01.02.03 Ka?21rte9 
2016-12?22ABWA+123 456789//Berliner S?23parkasse/DE?30BELADEBEXXX
?31DE01234567890123456789?32Berliner Sparkasse?34123
:62F:C161125EUR55,87
-
:20:STARTUMSE
:25:83050000/0123456789
:28C:00000/001
:60F:C161125EUR55,87
:61:1611281128DR24,97N037NONREF
:86:106?00KARTENZAHLUNG?101234?20SVWZ+2016-11-25T10.11.12 Ka?21rt
e9 2016-11?22ABWA+TK Maxx Berlin Schoene?23berg//Berlin/DE?30DRES
DEFF300?31DE01234567890123456789?32TK MAXX BERLIN SCHOE BERLIN?34
012
:62F:C161128EUR30,90
-</pre>
      </template>
    </test-fixture>

    <script>
      suite('<mt940-parser-service>', function() {
        var Mt940Parser;
        var AstElement;
        var home;
        var sut;
        var g;

        setup(function() {
          Mt940Parser = window.Mt940Parser;
          if (!(typeof Mt940Parser === 'object')) {
            assert.fail("Mt940Parser undefined");
          }
          AstElement = Mt940Parser.AstElement;

          home = fixture('mt940-parser-service-fixture');
          sut = Polymer.dom(home.root).querySelector('#sut');
          g = sut._grammar(Mt940Parser.ParserGenerator.Operators);

          defineAssertMethods(assert, Mt940Parser);
        });

        test('basic tokens correct', function() {
          assert.sameParseResult(g.number("42xxx"), ["42", "xxx"]);
          assert.sameParseResult(g.lbrace("{abc"), ["{", "abc"]);
          assert.sameParseResult(g.anychar("(42:answers everything)"),
              ["(42:answers everything)", ""]);
          assert.sameParseResult(g.anychar("x\ny"), ["x", "\ny"]);
        });

        test('parse tag', function() {
          assert.sameParseResult(g.tag("42:"),
              [new AstElement.Tag(["42", ":"]), ""]);
        });

        test('parse fieldname', function() {
          assert.sameParseResult(g.fieldName(":42:"), [
                new AstElement.FieldName([":",
                    new AstElement.Tag(["42", ":"])
                ]), ""]);
          assert.equal(g.fieldName(":42:")[0].tag().number(), "42");
        });

        test('parse headercontent', function() {
          assert.sameParseResult(g.headerContent("1:F01BPHKPLPKXXX0000000000"), [
              new AstElement.HeaderContent([
                  new AstElement.Tag(["1", ":"]),
                  "F01BPHKPLPKXXX0000000000"
              ]), ""]);
        });

        test('parse headerblock', function() {
          var result = g.headerBlock("{1:F01BPHKPLPKXXX0000000000}")[0];
          assert.equal(result.tagNumber(), "1");
          assert.equal(result.headerData(), "F01BPHKPLPKXXX0000000000");
        });

        test('parse header', function() {
          var result = g.header("{1:F01BPHKPLPKXXX0000000000}");
          assert.equal(result[1], "");
          var header = result[0];

          assert.instanceOf(header, AstElement.Header);
          assert.equal(header.headerBlocks().length, 1);
          var headerBlock0 = header.headerBlocks()[0];
          assert.instanceOf(headerBlock0, AstElement.HeaderBlock);
          assert.equal(headerBlock0.tagNumber(), "1");
          assert.equal(headerBlock0.headerData(), "F01BPHKPLPKXXX0000000000");
        });

        test('parse field', function() {
          var result = g.field(
                ":86:031?00Wyplata-(dysp/przel)?2069101012700004592221000000?2115619?\n"
              + "24Wplata na organ podatkowy?25Typ identyfikatora:N?26Zawartosc I\n"
              + "D:6792496639?27Okres:03M09?27Symbol formularza:PIT4?28Opis:ZAPL.\n"
              + "POD. DAFIK?3010101270?310004592221000000?32Urzad Skarbowy Krakow\n"
              + "tar?33e Miasto Krakow?38PL69101012700004592221000000\n")[0];
          assert.instanceOf(result, AstElement.Field);
          assert.equal(result.fieldname().tagNumber(), "86");
          assert.sameParseResult(result.fielddata(), 
            "031?00Wyplata-(dysp/przel)?2069101012700004592221000000?2115619?" +
            "24Wplata na organ podatkowy?25Typ identyfikatora:N?26Zawartosc I" +
            "D:6792496639?27Okres:03M09?27Symbol formularza:PIT4?28Opis:ZAPL." +
            "POD. DAFIK?3010101270?310004592221000000?32Urzad Skarbowy Krakow"+ 
            "tar?33e Miasto Krakow?38PL69101012700004592221000000");
        });

        test('parse fieldSet', function() {
          var result = g.fieldSet(
            ":60F:C031209PLN95,03\n" +
            ":61:0312091209C20000,FBARNONREF//1010001272972001\n" +
            "Payment of funds to own account\n" +
            ":86:082?00Wplata wlasna?2115616?24Rach.wplacajac. 101000\n" +
            "-\n"
          );

          assert.equal(result[1], "");
          assert.instanceOf(result[0], Mt940Parser.AstElement.FieldSet);
          assert.equal(result[0].fieldCount(), 3);

          var fields = result[0].fields();
          assert.equal(fields[0].fieldname().tagNumber(), "60F");
          assert.equal(fields[0].fielddata(), "C031209PLN95,03");
          assert.equal(fields[1].fieldname().tagNumber(), "61");
          assert.equal(fields[1].fielddata(), "0312091209C20000,FBARNONREF//1010001272972001Payment of funds to own account");
          assert.equal(fields[2].fieldname().tagNumber(), "86");
          assert.equal(fields[2].fielddata(), "082?00Wplata wlasna?2115616?24Rach.wplacajac. 101000");
        });

        test('parse fieldsInBraces', function() {
          var result = g.fieldsInBraces("{4:\n" +
            ":20: NETMEXID\n" + 
            "-}");
          assert.equal(result[1], "");
          assert.instanceOf(result[0], AstElement.FieldsInBraces);
          var fieldSets = result[0].fieldSets();
          assert.instanceOf(fieldSets, AstElement.FieldSets);
          assert.equal(fieldSets.fieldSetCount(), 1);
          var fields = fieldSets.fields();
          var field0 = fields[0];
          assert.instanceOf(field0, AstElement.Field);
          assert.equal(field0.fieldname().tagNumber(), "20");
          assert.equal(field0.fielddata(), " NETMEXID");
        });

        test('parse example domestic 1', function() {
          var example1 = Polymer.dom(home.root).querySelector('#example-swift-mt940-domestic-1');
          var parsed = sut.parseTransactions(example1.innerHTML);

          assert.instanceOf(parsed, AstElement.File);
          assert.instanceOf(parsed.body(), AstElement.Body);          
          var fields = parsed.body().fields();
          assert.equal(fields.length, 11);
          assert.instanceOf(fields[0], AstElement.Field);
        });

        test('parse example domestic 2', function() {
          var example1 = Polymer.dom(home.root).querySelector('#example-swift-mt940-domestic-2');
          var parsed = sut.parseTransactions(example1.innerHTML);

          assert.instanceOf(parsed, AstElement.File);
          assert.instanceOf(parsed.body(), AstElement.Body);          
          var fields = parsed.body().fields();
          assert.equal(fields.length, 12);
          assert.instanceOf(fields[0], AstElement.Field);
        });

        test('parse example international 1', function() {
          var example1 = Polymer.dom(home.root).querySelector('#example-swift-mt940-international-1');
          var parsed = sut.parseTransactions(example1.innerHTML);

          assert.instanceOf(parsed, AstElement.File);
          assert.instanceOf(parsed.body(), AstElement.Body);          
          var fields = parsed.body().fields();
          assert.equal(fields.length, 7);
          assert.instanceOf(fields[0], AstElement.Field);
        });

        test('parse example sparkasse 1', function() {
          var example1 = Polymer.dom(home.root).querySelector('#example-sparkasse-mt940-1');
          var parsed = sut.parseTransactions(example1.innerHTML);

          assert.instanceOf(parsed, AstElement.File);
          assert.instanceOf(parsed.body(), AstElement.Body);          
          assert.instanceOf(parsed.body().fieldSets(), AstElement.FieldSets);
          var fieldSets = parsed.body().fieldSets().fieldSets();
          assert.equal(fieldSets.length, 3);
          assert.equal(fieldSets[0].fieldCount(), 7);
          assert.equal(fieldSets[1].fieldCount(), 9);
          assert.equal(fieldSets[2].fieldCount(), 7);
          assert.instanceOf(fieldSets[0].fields()[0], AstElement.Field);
          var fields = parsed.body().fields();
          assert.equal(fields.length, 23);
          assert.instanceOf(fields[0], AstElement.Field);
        });
      });

      function defineAssertMethods(assert, Mt940Parser) {
          assert.samePrototype = function(actual, expected) {
            assert.equal(actual.prototype, expected.prototype,
              "Expected the prototype of:\n  " + expected + "\nbut got:\n  " + actual
            );
          }
          assert.sameParseResult = function(actual, expected) {
            try {
              if (actual == null) {
                assert.equal(actual, expected);
              } else if (actual instanceof Array) {
                if (!(expected instanceof Array)) {
                  throw new Error("actual is an array, but wasn't expected to be");
                }
                if (actual.length != expected.length) {
                  throw new Error("actual array has different length than expected array");
                }
                for (var i = 0; i < actual.length; i++) {
                  assert.sameParseResult(actual[i], expected[i]);
                }
              } else if(expected instanceof Mt940Parser.AstElement) {
                assert.samePrototype(actual, expected);
                assert.sameParseResult(actual.data, expected.data);
              } else {
                assert.equal(actual, expected);
              }
            } catch (ex) {
              throw new Error(ex.stack
                  + "\n\nExpected the actual parse result:\n  "
                  + JSON.stringify(actual) + "\nto be:\n  "
                  + JSON.stringify(expected) + "\nbut got the error above.");
            }
          };
      }
    </script>
  </body>
</html>
